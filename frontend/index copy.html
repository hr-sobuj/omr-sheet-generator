<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OMR — Strict 200/grid PDF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: 'Inter','Roboto','Noto Sans Bengali', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    .bubble { width: 24px; height: 24px; border-radius: 9999px; border: 2px solid #cbd5e1; display:inline-flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; margin-right:6px; box-sizing:border-box; vertical-align:middle; background: transparent; }
    .bubble-label { font-size:12px; margin-left:6px; color:#475569 }
    .a4 { width: 210mm; min-height: 297mm; padding: 18mm; background: white; box-sizing: border-box; page-break-after: always; }
    .compact-grid .bubble { width: 16px; height: 16px; font-size:10px; margin-right:4px; border-width:1.2px; }
    .compact-grid .bubble-label { display:none; }
    .compact-grid .a4 { padding: 12mm; }
    .no-select { user-select: none; -webkit-user-select: none; -ms-user-select: none; }
    @media print { .no-print { display:none } }
  </style>
</head>
<body class="bg-slate-100 p-8 no-select">
  <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="md:col-span-1 bg-white p-6 rounded-2xl shadow no-print">
      <h2 class="text-xl font-semibold mb-4">OMR সেটিংস</h2>

      <label class="block text-sm text-slate-600 mb-1">প্রতিষ্ঠানের নাম</label>
      <input id="institute" type="text" placeholder="উদাহরণ: ABC Institute" class="w-full border rounded p-2 mb-3" />

      <label class="block text-sm text-slate-600 mb-1">মোট প্রশ্ন</label>
      <input id="questions" type="number" min="1" max="1000" value="200" class="w-full border rounded p-2 mb-3" />

      <label class="block text-sm text-slate-600 mb-1">প্রশ্ন প্রতি অপশন</label>
      <input id="options" type="number" min="2" max="6" value="4" class="w-full border rounded p-2 mb-3" />

      <label class="block text-sm text-slate-600 mb-1">অপশন ভাষা</label>
      <select id="optionLang" class="w-full border rounded p-2 mb-3">
        <option value="eng">English (A, B, C)</option>
        <option value="bn">বাংলা (ক, খ, গ)</option>
      </select>

      <label class="block text-sm text-slate-600 mb-1">লেটার বুদ্বুদ ভিতরে দেখাবেন?</label>
      <div class="flex items-center gap-2 mb-3">
        <input id="insideBubble" type="checkbox" class="h-4 w-4" checked />
        <label for="insideBubble" class="text-sm text-slate-600">হ্যাঁ — অক্ষরগুলো বুদ্বুদে দেখাব (space বাঁচে)</label>
      </div>

      <label class="block text-sm text-slate-600 mb-1">বুদ্বুদ (border) রং</label>
      <input id="bubbleColor" type="color" value="#2b6cb0" class="w-full h-10 p-1 mb-3" />

      <label class="block text-sm text-slate-600 mb-1">শীট ধরন</label>
      <select id="layout" class="w-full border rounded p-2 mb-3">
        <option value="single">Single column</option>
        <option value="two">Two columns</option>
        <option value="grid">Grid (force max 200 per page)</option>
      </select>

      <label class="block text-sm text-slate-600 mb-1">Questions per page (0 = auto)</label>
      <input id="perPageManual" type="number" min="0" max="1000" value="0" class="w-full border rounded p-2 mb-3" />

      <label class="block text-sm text-slate-600 mb-1">লোগো (ঐচ্ছিক)</label>
      <input id="logo" type="file" accept="image/*" class="w-full mb-3" />

      <div class="flex gap-2">
        <button id="previewBtn" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
          <span class="material-icons align-middle">visibility</span> প্রিভিউ</button>
        <button id="downloadBtn" class="flex-1 bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">
          <span class="material-icons align-middle">download</span> PDF ডাউনলোড (strict)</button>
      </div>

      <p class="text-xs text-slate-500 mt-3">নোট: Grid সিলেক্ট করলে প্রতি কলামে ৫০ প্রশ্ন × ৪ কলাম = সর্বোচ্চ ২০০ প্রশ্ন থাকবে।</p>
    </div>

    <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">OMR প্রিভিউ</h2>
        <div class="text-sm text-slate-500">ডাউনলোডের আগে দেখে নিন</div>
      </div>

      <div id="previewArea" class="border rounded p-4 bg-slate-50 min-h-[420px]">
        <div class="text-slate-400">প্রিভিউ দেখতে "প্রিভিউ" বাটনে ক্লিক করুন।</div>
      </div>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    const previewBtn = document.getElementById('previewBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const previewArea = document.getElementById('previewArea');

    function clearPreview() { previewArea.innerHTML = ''; }

    function makeBubble(letter, inside, borderColor){
      const span = document.createElement('span');
      span.className = 'bubble';
      span.style.borderColor = borderColor || '#cbd5e1';
      if (inside) span.textContent = letter;
      return span;
    }

    function optionLetter(index, lang){
      if (lang === 'bn') return String.fromCharCode(0x0995 + index);
      return String.fromCharCode(65 + index);
    }

    function estimatePerPage(layout, opts, inside){
      if (layout === 'grid') return 200;
      let base = 36;
      if (layout === 'two') base = 72;
      const optsFactor = 4 / Math.max(2, opts);
      const insideFactor = inside ? 1.12 : 0.95;
      return Math.max(8, Math.floor(base * optsFactor * insideFactor));
    }

    function paginate(total, perPageManual, layout, opts, inside){
      let per = (perPageManual && perPageManual > 0) ? perPageManual : estimatePerPage(layout, opts, inside);
      if (layout === 'grid') per = Math.min(per, 200);
      const pages = [];
      let rem = total;
      while (rem > 0) { pages.push(Math.min(per, rem)); rem -= per; }
      return pages;
    }

    function renderPageBlock({inst, questionsSliceStart, questionsCount, opts, layout, logoData, lang, inside, borderColor, compact}){
      const container = document.createElement('div');
      container.className = 'a4';
      if (compact) container.classList.add('compact-grid');

      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-6';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-size:18px;font-weight:700">${inst||'—'}</div><div style="font-size:12px;color:#64748b">OMR Answer Sheet</div>`;
      header.appendChild(left);
      if (logoData){
        const img = document.createElement('img');
        img.src = logoData; img.style.maxHeight='48px'; img.style.objectFit='contain';
        header.appendChild(img);
      }
      container.appendChild(header);

      const questionsWrap = document.createElement('div');

      function makeRow(i){
        const row = document.createElement('div');
        row.className = 'flex items-center mb-1';
        row.style.flexWrap = 'wrap';
        const num = document.createElement('div');
        num.style.width = '34px';
        num.style.fontWeight = '600';
        num.textContent = i + '.';
        row.appendChild(num);
        for (let j=0; j<opts; j++){
          const letter = optionLetter(j, lang);
          const bubble = makeBubble(letter, inside, borderColor);
          row.appendChild(bubble);
          if (!inside){
            const lbl = document.createElement('span');
            lbl.className='bubble-label';
            lbl.textContent = letter;
            row.appendChild(lbl);
          }
        }
        return row;
      }

      if (layout === 'grid'){
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-4 gap-2';
        const colCount = 4;
        const perCol = 50;
        for (let c=0; c<colCount; c++){
          const colDiv = document.createElement('div');
          for (let r=0; r<perCol; r++){
            const qNum = questionsSliceStart + (c * perCol + r);
            if (qNum <= questionsSliceStart + questionsCount - 1){
              colDiv.appendChild(makeRow(qNum));
            }
          }
          grid.appendChild(colDiv);
        }
        questionsWrap.appendChild(grid);
      } else if (layout === 'two') {
        const grid = document.createElement('div'); grid.className='grid grid-cols-2 gap-2';
        const perCol = Math.ceil(questionsCount/2);
        const leftCol = document.createElement('div');
        const rightCol = document.createElement('div');
        for (let k=0;k<questionsCount;k++){
          const i = questionsSliceStart + k;
          if (k < perCol) leftCol.appendChild(makeRow(i));
          else rightCol.appendChild(makeRow(i));
        }
        grid.appendChild(leftCol); grid.appendChild(rightCol);
        questionsWrap.appendChild(grid);
      } else {
        for (let k=0;k<questionsCount;k++){
          const i = questionsSliceStart + k;
          questionsWrap.appendChild(makeRow(i));
        }
      }

      container.appendChild(questionsWrap);
      const footer = document.createElement('div');
      footer.className = 'mt-6 text-sm text-slate-600';
      footer.textContent = `Generated: ${new Date().toLocaleDateString()}`;
      container.appendChild(footer);
      return container;
    }

    async function getLogoData(fileInput){
      const f = fileInput.files && fileInput.files[0];
      if (!f) return null;
      return new Promise(res=>{
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.onerror = () => res(null);
        r.readAsDataURL(f);
      });
    }

    previewBtn.addEventListener('click', async ()=>{
      const inst = document.getElementById('institute').value.trim();
      const total = parseInt(document.getElementById('questions').value) || 0;
      const opts = parseInt(document.getElementById('options').value) || 0;
      const layout = document.getElementById('layout').value;
      const logoData = await getLogoData(document.getElementById('logo'));
      const lang = document.getElementById('optionLang').value === 'bn' ? 'bn' : 'eng';
      const inside = document.getElementById('insideBubble').checked;
      const borderColor = document.getElementById('bubbleColor').value || '#cbd5e1';
      const perPageManual = parseInt(document.getElementById('perPageManual').value) || 0;

      if (total <= 0 || opts < 2){ alert('অনুগ্রহ করে সঠিক সংখ্যা দিন'); return; }
      clearPreview();
      const pages = paginate(total, perPageManual, layout, opts, inside);
      let cursor = 1;
      pages.forEach(cnt=>{
        const compact = (layout === 'grid');
        const block = renderPageBlock({inst, questionsSliceStart: cursor, questionsCount: cnt, opts, layout, logoData, lang, inside, borderColor, compact});
        previewArea.appendChild(block);
        cursor += cnt;
      });
      previewArea.scrollIntoView({behavior:'smooth'});
    });

    downloadBtn.addEventListener('click', async ()=>{
      if (!previewArea.firstChild || previewArea.querySelector('.a4')===null){
        previewBtn.click();
        await new Promise(r=>setTimeout(r,450));
      }
      const pages = previewArea.querySelectorAll('.a4');
      if (!pages.length){ alert('প্রিভিউ তৈরিতে সমস্যা হয়েছে'); return; }

      const pdf = new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
      const marginMm = 8;
      const pxToMm = px => px * 0.264583;
      let first = true;

      for (let i=0;i<pages.length;i++){
        const page = pages[i];
        const clone = page.cloneNode(true);
        clone.style.background = '#ffffff';
        document.body.appendChild(clone);
        await new Promise(r=>setTimeout(r,80));
        const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        const pageWidthMm = 210;
        const availableWidthMm = pageWidthMm - marginMm*2;
        const imgWidthMm = pxToMm(canvas.width);
        const imgHeightMm = pxToMm(canvas.height);
        const scale = Math.min(1, availableWidthMm / imgWidthMm);
        const renderW = imgWidthMm * scale;
        const renderH = imgHeightMm * scale;
        const x = (pageWidthMm - renderW) / 2;
        const y = marginMm;
        if (!first) pdf.addPage();
        pdf.addImage(imgData, 'JPEG', x, y, renderW, renderH, undefined, 'FAST');
        first = false;
        document.body.removeChild(clone);
      }

      const inst = document.getElementById('institute').value.trim() || 'OMR';
      const fname = `${inst.replace(/[^a-z0-9\-\_]/gi,'_')}_${new Date().toISOString().slice(0,10)}.pdf`;
      pdf.save(fname);
    });
  </script>
</body>
</html>
